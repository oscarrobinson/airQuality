<!DOCTYPE html>
<html>
	<head>
		<title>London Air Quality - Data Visualisation</title>
		<link rel="stylesheet" href="assets/css/reset.css" type="text/css">
		<!-- <link rel="stylesheet" href="ls/css/animate.css">  -->
		<link rel="stylesheet" href="ls/css/liquid-slider.css">
		<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/pure-min.css">
		<link rel="stylesheet" href="assets/css/style.css" type="text/css">

		<script src="http://d3js.org/d3.v3.min.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<script src="assets/js/jquery.leanModal.min.js"></script>
		<script src="assets/js/trafficChart.js"></script>

		<meta name="apple-mobile-web-app-capable" content="yes">
		
	</head>
	<body>
		<div id="row">
			<div id="site1">
				<div class="locationSwitch">
					<div class="liquid-slider" id="siteSliderLeft">
						<div id="eriLoc">
							<div class="locationCode" id="ERI"></div>
							<h2 class="title">Bexley - Erith</h2>
							
							<div class="iconStrip">
								<a id="infoEri" name="testModal" href="#testModal"><img src="assets/glyphs/circle_info.png" height="32" ></a>
								<a href="#"><img src="assets/glyphs/gm2.png" height="25"  ></a>
								<a href="#"><img src="assets/glyphs/sv2.png" height="25" ></a>
							</div>
							
							<div id="trafficWrapper1l"></div>
							<script>
								loadTraffic(eriTraffic, 1, "l");
							</script>
						</div>
						<div id="briLoc">
							<div class="locationCode" id="BRI"></div>
							<h2 class="title">Lambeth - Brixton</h2>
							<div id="trafficWrapper2l"></div>
							<script>
								loadTraffic(briTraffic, 2, "l");			
							</script>
						</div>
						<div id="horLoc">
							<div class="locationCode" id="HOR"></div>
							<h2 class="title">Westminster - Horseferry</h2>
							<div id="trafficWrapper3l"></div>
							<script>
								loadTraffic(horTraffic, 3, "l");			
							</script>
						</div>
						<div id="ricLoc">
							<div class="locationCode" id="RIC"></div>
							<h2 class="title">Richmond - Ntl Physical Lab</h2>
							<div id="trafficWrapper4l"></div>
							<script>
								loadTraffic(ricTraffic, 4, "l");			
							</script>
						</div>
						<div id="oxLoc">
							<div class="locationCode" id="WM6"></div>
							<h2 class="title">Westminster - Oxford Street</h2>
							<div id="trafficWrapper5l"></div>
							<script>
								loadTraffic(oxTraffic, 5, "l");			
							</script>
						</div>
					</div>
				</div>


				<div id="left-graph-container">
					<div class="canvas" id="canvasLeft"></div>
				</div>
			</div>

			<div id="site2">
				<div class="locationSwitch">
					<div class="liquid-slider" id="siteSliderRight">
						<div id="briLoc">
							<div class="locationCode" id="BRI"></div>
							<h2 class="title">Lambeth - Brixton</h2>
							<div id="trafficWrapper2r"></div>
							<script>
								loadTraffic(briTraffic, 2, "r");			
							</script>
						</div>
						<div id="horLoc">
							<div class="locationCode" id="HOR"></div>
							<h2 class="title">Westminster - Horseferry</h2>
							<div id="trafficWrapper3r"></div>
							<script>
								loadTraffic(horTraffic, 3, "r");			
							</script>
						</div>
						<div id="ricLoc">
							<div class="locationCode" id="RIC"></div>
							<h2 class="title">Richmond - Ntl Physical Lab</h2>
							<div id="trafficWrapper4r"></div>
							<script>
								loadTraffic(ricTraffic, 4, "r");			
							</script>
						</div>
						<div id="oxLoc">
							<div class="locationCode" id="WM6"></div>
							<h2 class="title">Westminster - Oxford Street</h2>
							<div id="trafficWrapper5r"></div>
							<script>
								loadTraffic(oxTraffic, 5, "r");			
							</script>
						</div>
						<div id="eriLoc">
							<div class="locationCode" id="ERI"></div>
							<h2 class="title">Bexley - Erith</h2>
							<div id="trafficWrapper1r"></div>
							<script>
								loadTraffic(eriTraffic, 1, "r");
							</script>
						</div>

					</div>
				</div>
				<div id="right-graph-container">
					<div class="canvas" id="canvasRight"></div>
				</div>
			</div>


		</div>
		<div id="controls">
			<div id="time-controls">
			<div id="day_select" class="menu">
			    <ul>
			        <li class="selected"><a href="#">Mon</a></li>
			        <li><a href="#">Tue</a></li>
			        <li><a href="#">Wed</a></li>
			        <li><a href="#">Thu</a></li>
			        <li><a href="#">Fri</a></li>
			        <li><a href="#">Sat</a></li>
			         <li><a href="#">Sun</a></li>
			    </ul>
			</div>
			<div id="season_select" class="menu">
			    <ul>
			        <li class="selected"><a href="#">Spring</a></li>
			        <li><a href="#">Summer</a></li>
			        <li><a href="#">Autumn</a></li>
			        <li><a href="#">Winter</a></li>
			    </ul>
			</div>
			</div>
		</div>
		<div id="testModal">
			<a class="modal_close" href="#"></a>
			<iframe src="https://www.google.com/maps/embed?pb=!1m14!1m8!1m3!1d2485.318665050197!2d-0.11272739999999996!3d51.4706648!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x48760461c3a262cd%3A0x645413708b174028!2sBrixton+Rd!5e0!3m2!1sen!2s!4v1404922032145" width="400" height="300" frameborder="0" style="border:0"></iframe>
		</div>
		<script>

			// JavaScript element sizing

			var windowHeight = window.innerHeight;
			var windowWidth =  window.innerWidth;
			var rowHeight = windowHeight - 92
			 + "px";

			var rowElement = document.getElementById("row");
			rowElement.style.height = rowHeight;
			//console.log(rowElement);


			var colWidth = $("#site1").width();
			//console.log(colWidth);

			var panelWidth = $("#firstSlide").width();
			//console.log(panelWidth);


		</script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>
		<script src="http:////cdnjs.cloudflare.com/ajax/libs/jquery.touchswipe/1.6.4/jquery.touchSwipe.js"></script>
		<script src="ls/js/jquery.liquid-slider.min.js"></script>
		<script>
		var sideClicked = "";

		$(function(){
		     $('#siteSliderLeft').liquidSlider({
		     	//continuous:false,
		     	hoverArrows: false,
		     	preLoader:false,
		     	slideEaseDuration: 100,
		     	dynamicTabs:true,
		     	includeTitle: true,
		     	callback: function(){
		     		sideClicked = "left";
		     		setCurrentLocations();
		     	}
				
		     });
		});

		$(function(){
		     $('#siteSliderRight').liquidSlider({
		     	//continuous:false,
		     	hoverArrows: false,
		     	preLoader:false,
		     	slideEaseDuration: 100,
		     	//dynamicArrowsGraphical:false,
		     	//dynamicArrowLeftText: " << ",
		     	//dynamicArrowRightText: " >>",
		     	callback: function(){
		     		sideClicked = "right";
		     		setCurrentLocations();
		     	}
		     });
		});

		$("#infoEri").leanModal({ top : 200, overlay : 0.4, closeButton: ".modal_close" });

		//Current location right is actually current location left <@:^)
		var currentLocationLeft = "BRI";
		var currentLocationRight = "ERI";


		function setCurrentLocations(){
			var s1 = $("#site1").find( "#siteSliderLeft .currentPanel").find(".panel-wrapper").find(".locationCode");
			var s2 = $("#site2").find( "#siteSliderRight .currentPanel").find(".panel-wrapper").find(".locationCode");
			var newS1 = $(s1).closest(".locationCode").attr("id");
			var newS2 = $(s2).closest(".locationCode").attr("id");
			if (newS1 === currentLocationRight && newS2 === currentLocationLeft){
				console.log(sideClicked);
				if(sideClicked==="left"){
					newS1="ERI";
				}
				else if(sideClicked==="right"){
					newS2="BRI";
				}
			}
			currentLocationRight = newS1;
			currentLocationLeft = newS2;
			console.log("RIGHT LOCATION: "+currentLocationLeft+" || LEFT LOCATION: "+currentLocationRight);
			getDataForSeasonAndDay($('#season_select').find('.selected').text(), $('#day_select').find('.selected').text(),currentLocationLeft, "left");

			getDataForSeasonAndDay($('#season_select').find('.selected').text(), $('#day_select').find('.selected').text(),
				currentLocationRight, "right");

		}

			var canvasWidth = 384;

			var width = 370;
			var height = 370;
			var horPadding = 34;
			var verPadding = 110;
			var maxRadius = (width / 2) - 10;
			// dynamic center
			var cx = (width / 2) + horPadding;
			var cy = (height / 2) + verPadding;
			// max shape space

			var  canvasLeft = d3.select('#canvasLeft').append('svg')
			    .attr('width', width + (2 * horPadding))
			    .attr('height', height + (2 * verPadding));

			var canvasRight = d3.select('#canvasRight').append('svg')
			    .attr('width', width + (2 * horPadding))
			    .attr('height', height + (2 * verPadding));


		var pie = d3.layout.pie()
			.sort(null)
			.value(function (d) {
			   	return 1;
			});

		var groupLeft = canvasLeft.append('g')
			.attr('class', 'graph_box_left');

		var groupRight = canvasRight.append('g')
			.attr('class', 'graph_box_right');


		var leftScaleGroup = canvasLeft.append("g")
							.attr("class", "scale_box_left")

		var rightScaleGroup = canvasRight.append("g")
							.attr("class", "scale_box_right")

		var graphData = []

		// SEGMENTS
		var loadGraph = function(graphData, scaleGroup, canvas,side, scaleMax){


			////SCALE STUFF//////

			//console.log(scaleMax);

			// compute scale ceiling
			var maxReading = parseFloat(scaleMax);

		/*	for(i=0; i<graphData.length; i++){
				//console.log("Hour: "+graphData[i].hour+"  || Reading: "+graphData[i].reading);
				if (Math.round(graphData[i].reading) > maxReading) {
					maxReading = graphData[i].reading;
				}
				//console.log("maxReading" + maxReading);
			}*/

			//console.log(maxReading);

			var scaleCeil = Math.ceil(maxReading/50)*50;

			//console.log(scaleCeil);

			// color scale
			var color = d3.scale.linear()
				.domain([0, scaleCeil])
			    .range(['#DDDDDD', '#F25757']);

			// data scale
			var scale = d3.scale.linear()
				.domain([0, scaleCeil])
				.range([0, maxRadius]);

			var arc = d3.svg.arc()
				.innerRadius(20)
				.outerRadius(function (d, i) {
					return Math.round(20 + scale(d.data.reading));	
				});	

			var circleData = [];

			for (var i = 0; (i * 50) <= scaleCeil; i++) {
				circleData[i] = (i * 50);
				//console.log("circleData i" + circleData[i]); 
			}

			// axes

			var circles = scaleGroup.selectAll("circle")
				.data(circleData)
			
			circles.enter()
				.append("circle");

			circles.exit().remove();

			var circleAttr = circles
				.transition()
				.duration(500)
				.attr("cx", cx)
				.attr("cy", cy)
				.attr("r",  function (d) { return 20 + scale(d); })
				.attr("fill", "none")
				.attr("stroke", "#444444")
				.attr("stroke-dasharray", "1,4");

			// time labels
			var labelData = [ 
				{ hour: 0, value: "12:00"},
				{ hour: 1, value: "13:00"},
				{ hour: 2, value: "14:00"},
				{ hour: 3, value: "15:00"},
				{ hour: 4, value: "16:00"},
				{ hour: 5, value: "17:00"},
				{ hour: 6, value: "18:00"},
				{ hour: 7, value: "19:00"},
				{ hour: 8, value: "20:00"},
				{ hour: 9, value: "21:00"},
				{ hour: 10, value: "22:00"},
				{ hour: 11, value: "23:00"},
				{ hour: 12, value: "00:00"},
				{ hour: 13, value: "01:00"},
				{ hour: 14, value: "02:00"},
				{ hour: 15, value: "03:00"},
				{ hour: 16, value: "04:00"},
				{ hour: 17, value: "05:00"},
				{ hour: 18, value: "06:00"},
				{ hour: 19, value: "07:00"},
				{ hour: 20, value: "08:00"},
				{ hour: 21, value: "09:00"},
				{ hour: 22, value: "10:00"},
				{ hour: 23, value: "11:00"}
			]

			var labelGroup = canvas.append("g")
				.attr('transform', 'translate(' + cx + ',' + cy + ')');

			var labels = labelGroup.selectAll("text")
				.data(labelData)
				.enter()
				.append("text");

			canvas.append('text')
				.attr('class', 'unitText')
				.attr('transform', 'translate(' + cx + ',' + cy + ')')
				.text('NO2')
				.attr('dx', "-1em");

			canvas.append('text')
				.attr('class', 'unitText')
				.attr('transform', 'translate(' + cx + ',' + cy + ')')
				.text('ug m-3')
				.attr('dx', "-1.6em")
				.attr('dy', "1em");

			var labelAttr = labels
				.attr('font-size', '10px')
				.attr('text-anchor', 'middle')
			    .attr('font-family', 'sans-serif')
			    .attr('fill', '#8C8C8C')
			  	.attr('dy', -(maxRadius + 25))
			  	.attr('transform', function (d) {
			  		var r = 15 * d.hour;
			  		return "rotate(" + r + ")";
			  	})
			  	.text(function (d) {
			    	return d.value;
				});

			//////----------END OF SCALE STUFF ---------- ///////

			
			group = canvas.select('.graph_box_'+side)
				.attr('transform', 'translate('+cx+', '+cy+')');

			//console.log(group);

			var g_path = group.selectAll('path')
			    .data(pie(graphData));

			var g_text = group.selectAll('text')
				.data(pie(graphData));
			

			g_path.enter().append('path')
			    .attr('d', arc)
			    .attr('stroke', 'white')
			    .attr('stroke-width', '1')
			    .attr('stroke-linecap', 'square')
			    .attr('fill', function (d, i) {
			    	return color(d.data.reading);
				});

			g_path
				.transition()
				.duration(500)
			    .attr('d', arc)
			    .attr('stroke', 'white')
			    .attr('stroke-width', '1')
			    .attr('stroke-linecap', 'square')
			    .attr('fill', function (d, i) {
			    	return color(d.data.reading);
				});


			g_path.exit().remove();


			g_text.enter().append('text')
			    .attr('text-anchor', 'middle')
			    .attr('font-size', '9px')
			    .attr('font-weight', 'bold')
			    .attr('font-family', 'sans-serif')
			    .attr('fill', '#333333')
			    .text(function (d, i) {
			    	return Math.round(d.data.reading);
				})
				.attr('transform', function (d) {
			    	var c = arc.centroid(d);
			    	return "translate(" + c[0]*2.0 +"," + c[1]*2.0 + ")";
				});

			g_text
				.transition()
				.duration(500)
			    .attr('text-anchor', 'middle')
			    .attr('font-size', '9px')
			    .attr('font-weight', 'bold')
			    .attr('font-family', 'sans-serif')
			    .attr('fill', '#333333')
			    .text(function (d, i) {
			    	return Math.round(d.data.reading);
				})
				.attr('transform', function (d) {
			    	var c = arc.centroid(d);
			    	return "translate(" + c[0]*2.0 +"," + c[1]*2.0 + ")";
				});

			g_text.exit().remove();
		}




		$( "#season_select li" ).click(function() {
			$("#season_select li").removeClass("selected");
			$(this).addClass("selected");
			var season = $(this).text();
			getDataForSeasonAndDay($('#season_select').find('.selected').text(), $('#day_select').find('.selected').text(),
				currentLocationLeft, "left");

			getDataForSeasonAndDay($('#season_select').find('.selected').text(), $('#day_select').find('.selected').text(),
				currentLocationRight, "right");
		});

		$( "#day_select li" ).click(function() {
			$("#day_select li").removeClass("selected");
			$(this).addClass("selected");
			var day = $(this).text();
			getDataForSeasonAndDay($('#season_select').find('.selected').text(), $('#day_select').find('.selected').text(),
				currentLocationLeft, "left");

			getDataForSeasonAndDay($('#season_select').find('.selected').text(), $('#day_select').find('.selected').text(),
				currentLocationRight, "right");
		});







		var filteredData = [];

		function getDataForDay(season, date, location, f){
			$.getJSON('data/data.json', function(data) {         	
    			var dataForSeason = data[location][season];
    			var dataForDate;
    			for(i=0; i<dataForSeason.length; i++){
    				if(dataForSeason[i].Date===date){
    					dataForDate = dataForSeason[i].Data;
    				}
    			}
    			f(dataForDate);
			});
		}



		function getDataForDayInSeason(dataForSeason, day){
			    var c = 0;
    			var filteredData = [];
    			for (i=0; i<24; i++){
    				filteredData.push({"hour":i, "reading":0})
    			}
    			for(i=0; i<dataForSeason.length; i++){
    				var dataForDay = dataForSeason[i];
    				if(dataForDay.Day === day){
    					for(x=0; x < dataForDay.Data.length; x++){
    						var noDataForDayFlag = false;
    						var thisData = dataForDay.Data[x].reading;
    						var val = 0;
    						if(thisData !== "")
    						{
    							val = parseFloat(thisData);
    						}
    						else{
    							noDataForDayFlag=true;
    						}
    						//console.log(val);
    						filteredData[x].reading+=val;
    					}
    					if(!noDataForDayFlag){
    						c++;
    					}
    				}
    			}

    			for(i=0; i<filteredData.length; i++){
    				filteredData[i].reading = filteredData[i].reading/c;
    			}

    			return filteredData;
		}

		function getMaxForWeek(data, season, location1, location2){
			var location1Data = data[location1][season];
			var location2Data = data[location2][season];
			var max1 = getMaxForLocationSeason(location1Data);
			var max2 = getMaxForLocationSeason(location2Data);
			//console.log("Max For Location 1: "+max1+" || Max For Location 2: "+max2);
			if(max1 > max2){
				return max1;
			}
			else{
				return max2;
			}
		}


		function getMaxForLocationSeason (dataForLocSeason){
				var maxReading = 0;
				var filteredData = [];
				var days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
				//console.log(days.length);
				for(y=0; y<days.length; y++){
					//console.log("pushing data for day "+days[y])
					filteredData.push(getDataForDayInSeason(dataForLocSeason, days[y]));
				}

				//console.log(filteredData);

				for(i=0; i<filteredData.length; i++){
					var dayData = filteredData[i];
					for (x=0; x<dayData.length; x++){
						if(dayData[x].reading!==""){
							//console.log("Day Data "+dataForLoc[i].Day+" "+dataForLoc[i].Date+": "+Math.round(dayData[x].reading));
							if (Math.round(dayData[x].reading) > maxReading) {
								maxReading = Math.round(dayData[x].reading);
								//console.log("New Max Reading: "+maxReading);
							}
						}
					}
				}

				return maxReading;
		}


		function getDataForSeasonAndDay(season, day, location, graphSide){
			$.getJSON('data/data.json', function(data) {         
    			var dataForSeason = data[location][season];
    			//console.log(dataForSeason);
    			//console.log(maxDataReading);
    			//console.log(dataForSeason);
    			var filteredData = getDataForDayInSeason(dataForSeason,day);
    			var maxDataReading = getMaxForWeek(data, season, currentLocationLeft, currentLocationRight);

    			//console.log(maxDataReading);
    			flippedData = []

    			for(h=12; h<24; h++){
    				flippedData.push(filteredData[h]);
    			}
    			for(h=0; h<12; h++){
    				flippedData.push(filteredData[h]);
    			}

    			if(graphSide === "left"){
    				loadGraph(flippedData, leftScaleGroup, canvasRight,"right", maxDataReading);
    			}
    			if(graphSide === "right"){
    				loadGraph(flippedData, rightScaleGroup, canvasLeft, "left", maxDataReading);
    			}
			});	
		}



			getDataForSeasonAndDay($('#season_select').find('.selected').text(), $('#day_select').find('.selected').text(),currentLocationLeft, "left");

			getDataForSeasonAndDay($('#season_select').find('.selected').text(), $('#day_select').find('.selected').text(),
				currentLocationRight, "right");

		</script>
	</body>
</html>